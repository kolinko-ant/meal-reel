<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MealReel ‚Äì save Shorts recipes</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a">
  <style>
    :root{
      --bg:#f8fafc; --surface:#ffffff; --text:#0f172a; --muted:#475569;
      --line:#e2e8f0; --line2:#cbd5e1; --accent:#2563eb;
      --bfast:#fef3c7; --lunch:#dcfce7; --dinner:#e0e7ff; --dessert:#ffe4e6;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:linear-gradient(180deg,#fff,#f8fafc);border-bottom:1px solid var(--line);padding:14px;z-index:10}
    h1{margin:0;font-size:18px}
    main{padding:16px;max-width:1000px;margin:auto}
    input,button{padding:12px;border-radius:12px;border:1px solid var(--line2);background:#fff;color:var(--text)}
    input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px rgba(37,99,235,.12)}
    button{cursor:pointer}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn-soft{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8;text-decoration:none;display:inline-flex;align-items:center;padding:8px 12px;border-radius:10px}
    .empty-wrap{display:flex;align-items:center;justify-content:center;min-height:60vh}
    .empty{background:var(--surface);border:1px dashed var(--line2);border-radius:16px;padding:24px;max-width:720px;width:100%;text-align:center}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
    .tab{padding:8px 12px;border:1px solid var(--line2);background:#fff;border-radius:999px;cursor:pointer}
    .tab.active{background:#111827;color:#fff;border-color:#111827}
    .list{display:flex;flex-direction:column;gap:10px}
    .row{display:grid;grid-template-columns:120px 1fr; gap:12px; padding:10px; border:1px solid var(--line); border-radius:14px; background:#fff; align-items:center}
    .thumb{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:10px;background:#eee}
    .title{font-weight:650;line-height:1.25}
    .meta{display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap;margin-top:6px}
    .pill{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--line2);text-transform:capitalize}
    .pill.breakfast{background:var(--bfast);}
    .pill.lunch{background:var(--lunch);}
    .pill.dinner{background:var(--dinner);}
    .pill.dessert{background:var(--dessert);}
    .error{color:#b91c1c;font-size:14px;margin-top:8px}
    .fab{position:fixed; right:16px; bottom:16px; padding:14px 16px; border-radius:999px; background:var(--accent); color:#fff; border:none; box-shadow:0 12px 24px rgba(37,99,235,.35); font-weight:600}
    select.cat{padding:6px 8px;border-radius:8px}
  </style>
</head>
<body>
<header>
  <h1>üçΩÔ∏è MealReel</h1>
  <div class="tabs" id="tabs" style="display:none">
    <button class="tab active" data-f="all">All</button>
    <button class="tab" data-f="breakfast">Breakfast</button>
    <button class="tab" data-f="lunch">Lunch</button>
    <button class="tab" data-f="dinner">Dinner</button>
    <button class="tab" data-f="dessert">Dessert</button>
  </div>
</header>

<main>
  <section class="empty-wrap" id="empty">
    <div class="empty">
      <h2>Save your first recipe reel</h2>
      <p>Paste a <b>YouTube Shorts</b> link.</p>
      <form id="addFormEmpty" autocomplete="off">
        <input id="urlEmpty" placeholder="https://www.youtube.com/shorts/‚Ä¶" required>
        <button type="submit" class="btn-primary">Add</button>
        <div class="error" id="errorEmpty" style="display:none"></div>
      </form>
    </div>
  </section>

  <section id="mainList" style="display:none">
    <div class="list" id="list"></div>
  </section>
</main>

<button class="fab" id="fab" style="display:none">Ôºã Add</button>

<script>
  // ===== IndexedDB =====
  const DB_NAME='mealreel-db', STORE='videos', LSTORE='learning';
  const req=indexedDB.open(DB_NAME,3);
  req.onupgradeneeded=e=>{
    const db=e.target.result;
    if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE,{keyPath:'id'});
    if(!db.objectStoreNames.contains(LSTORE)) db.createObjectStore(LSTORE,{keyPath:'token'});
  };
  const dbp=new Promise(res=>req.onsuccess=()=>res(req.result));
  const store=(n,m='readonly')=>dbp.then(db=>db.transaction(n,m).objectStore(n));
  const put=async it=>(await store(STORE,'readwrite')).put(it);
  const all=async()=>new Promise(async r=>{const q=(await store(STORE)).getAll();q.onsuccess=()=>r(q.result||[])});
  const biasGetAll=async()=>new Promise(async r=>{const q=(await store(LSTORE)).getAll();q.onsuccess=()=>r(q.result||[])});
  const biasUpsert=async(token,cat,delta=2)=>{const s=await store(LSTORE,'readwrite');const g=s.get(token);await new Promise(rs=>g.onsuccess=()=>rs());const cur=g.result||{token,bias:{breakfast:0,lunch:0,dinner:0,dessert:0}};cur.bias[cat]=(cur.bias[cat]||0)+delta;s.put(cur)};

  // ===== Utils =====
  function isValidShortsUrl(u){
    try{
      const x=new URL(u.trim());
      const host=x.hostname.replace(/^www\./,'');
      // allow youtube.com or m.youtube.com; require /shorts/<id>
      return (host==='youtube.com' || host==='m.youtube.com') && x.pathname.startsWith('/shorts/');
    }catch{return false}
  }
  function shortsIdFromUrl(u){try{return new URL(u).pathname.split('/')[2].split('?')[0]}catch{return null}}
  async function fetchOEmbed(u){
    try{
      const r=await fetch('https://www.youtube.com/oembed?format=json&url='+encodeURIComponent(u));
      if(!r.ok) throw 0;
      return await r.json();
    }catch(e){
      // graceful fallback
      return { title:'Recipe', author_name:'' };
    }
  }
  function extractHashtags(s=''){ return (s.match(/#([a-z0-9_]+)/gi)||[]).map(h=>h.slice(1).toLowerCase()); }
  function tokensFromTitle(s=''){
    // IMPORTANT: use \s (not \\s)
    return s.toLowerCase().replace(/[^a-z0-9#\s]/g,' ').split(/\s+/).filter(Boolean);
  }

  // ===== Classifier (client-only) =====
  const LEX={
    breakfast:['breakfast','omelette','oat','porridge','pancake','granola','yogurt','scramble','toast'],
    lunch:['lunch','salad','wrap','bowl','sandwich'],
    dinner:['dinner','pasta','curry','stew','stir','bake','roast','steak'],
    dessert:['dessert','cake','cookie','brownie','cheesecake','tiramisu','mousse','pudding','ice','cream','sweet']
  };
  const FOOD=['recipe','cook','meal','food','protein','diet','healthy','kcal','calories'];
  const NOTFOOD=['prank','dance','makeup','tech','asmr','gaming','football'];

  async function scoreCategory(title){
    const t=title.toLowerCase();
    const tokens=[...new Set([...tokensFromTitle(t),...extractHashtags(t)])];
    const score={breakfast:0,lunch:0,dinner:0,dessert:0};
    let food=0; FOOD.forEach(w=>{ if(t.includes(w)) food++ }); NOTFOOD.forEach(w=>{ if(t.includes(w)) food-- });
    for(const[cat,ws]of Object.entries(LEX)){ ws.forEach(w=>{ if(t.includes(w)||tokens.includes(w)) score[cat]++ }) }
    const biases=await biasGetAll(); biases.forEach(b=>{ if(tokens.includes(b.token)){ for(const c in b.bias) score[c]+=b.bias[c] }});
    const best=Object.entries(score).sort((a,b)=>b[1]-a[1])[0];
    return { ok: food>0, cat: best && best[1]>0 ? best[0] : 'lunch', tokens };
  }

  // ===== Add flow =====
  async function addShort(url){
    if(!isValidShortsUrl(url)) throw new Error('Only YouTube Shorts links are supported');
    const meta=await fetchOEmbed(url); // won‚Äôt block add if it fails
    const {ok,cat,tokens}=await scoreCategory(meta.title||'');
    if(!ok) throw new Error('This doesn‚Äôt look like a recipe reel');
    const id=crypto.randomUUID();
    const vid=shortsIdFromUrl(url);
    const item={ id, url, title: meta.title||'Recipe', channel: meta.author_name||'', category: cat, thumb: `https://img.youtube.com/vi/${vid}/hqdefault.jpg`, addedAt: Date.now() };
    await put(item);
    return {item,tokens};
  }

  // ===== UI =====
  let filter='all';
  function setFilter(f){ filter=f; document.querySelectorAll('#tabs .tab').forEach(b=>b.classList.toggle('active',b.dataset.f===f)); render(); }

  async function render(){
    const items=await all();
    const has=items.length>0;
    document.getElementById('empty').style.display=has?'none':'';
    document.getElementById('mainList').style.display=has?'':'none';
    document.getElementById('fab').style.display=has?'':'none';
    document.getElementById('tabs').style.display=has?'flex':'none';
    if(!has) return;

    const filtered=items.filter(i=>filter==='all'?true:i.category===filter).sort((a,b)=>b.addedAt-a.addedAt);
    document.getElementById('list').innerHTML=filtered.map(i=>`
    <div class="row" data-id="${i.id}">
      <img class="thumb" src="${i.thumb}" alt="">
      <div>
        <div class="title">${i.title}</div>
        <div class="meta">
          <span class="pill ${i.category}">${i.category}</span>
          <select class="cat">
            ${['breakfast','lunch','dinner','dessert'].map(c=>`<option value="${c}" ${c===i.category?'selected':''}>${c}</option>`).join('')}
          </select>
          <a class="btn-soft" href="${i.url}" target="_blank" rel="noopener">‚ñ∂ Watch</a>
        </div>
      </div>
    </div>`).join('');
  }

  // events
  document.getElementById('addFormEmpty').addEventListener('submit', async e=>{
    e.preventDefault();
    const u=document.getElementById('urlEmpty').value.trim();
    const err=document.getElementById('errorEmpty'); err.style.display='none'; err.textContent='';
    try{ await addShort(u); document.getElementById('urlEmpty').value=''; render(); }
    catch(ex){ err.textContent=ex.message||'Failed to add link'; err.style.display='block'; }
  });
  document.getElementById('tabs').addEventListener('click', e=>{ const b=e.target.closest('.tab'); if(b) setFilter(b.dataset.f); });
  document.getElementById('fab').addEventListener('click', async()=>{ const u=prompt('Paste Shorts link:'); if(u) try{ await addShort(u); render(); }catch(ex){ alert(ex.message); }});
  document.addEventListener('change', async e=>{
    if(!e.target.matches('select.cat')) return;
    const row=e.target.closest('.row'); const id=row?.dataset.id;
    const items=await all(); const item=items.find(x=>x.id===id); if(!item) return;
    const next=e.target.value; if(next===item.category) return;
    const old=item.category; item.category=next; await put(item);
    // learn from correction
    const {tokens}=await scoreCategory(item.title); tokens.forEach(tok=>biasUpsert(tok,next,2));
    render();
  });

  render();
</script>

<script>
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
</script>
</body>
</html>
